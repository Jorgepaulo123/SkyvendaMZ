import { ClipboardList, DotSquare, Eye, Grid, Heart, Info, Kanban, Loader, Megaphone, MessageCircle, MoreHorizontal, Settings, User2, UserCheck, UserPlus, Award, Package, Star } from 'lucide-react';
import React, { useContext, useEffect, useState } from 'react'
import { Link, useLocation, useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { useWebSocket } from '../../context/websoketContext';
import api from '../../api/api';
import axios from 'axios';
import { HomeContext } from '../../context/HomeContext';
import { base_url } from '../../api/api';
import Pedidos from '../pedidos';
import toast from 'react-hot-toast';

export default function Profile() {
    // Estados
    const [hasProfile, setHasProfile] = useState(false);
    const [isMyProfile, setIsMyProfile] = useState(false);
    const [userProfile, setUserProfile] = useState(null);
    const [tabSelected, setTabSelected] = useState('posts');
    const [loading, setLoading] = useState(true);
    const [products, setProducts] = useState([]);
    const [loadingProducts, setLoadingproducts] = useState(true);
    const [isPublic, setIsPublic] = useState(false);
    const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
    const [showTooltip, setShowTooltip] = useState(false);
    const [openAvatarMenu, setOpenAvatarMenu] = useState(false);
    const [fileImage, setFileImage] = useState(null);
    const [message, setMessage] = useState('');
    const [previewImage, setPreviewImage] = useState(null);
    const [uploading, setUploading] = useState(false);
    const [followLoading, setFollowLoading] = useState(false); // Estado para controlar a animação do botão de seguir
    
    // Hooks
    const { setChats, setSelectedUser } = useWebSocket();
    
    // Função para abrir o chat com o usuário
    const handleOpenChat = (user) => {
        if (!user || !user.id) {
            toast.error('Não foi possível abrir o chat com este usuário');
            return;
        }
        
        // Criar um objeto de chat com as informações do usuário
        const chatUser = {
            id: user.id,
            nome: user.nome || user.name,
            username: user.username,
            foto: user.foto_perfil || user.perfil,
            mensagens: []
        };
        
        // Atualizar o estado do chat no contexto do WebSocket
        setSelectedUser(chatUser);
        
        // Adicionar o chat à lista de chats se ainda não existir
        setChats(prevChats => {
            // Verificar se já existe um chat com este usuário
            const existingChatIndex = prevChats.findIndex(chat => String(chat.id) === String(user.id));
            
            if (existingChatIndex !== -1) {
                // Se já existe, colocar no topo da lista
                const existingChat = prevChats[existingChatIndex];
                const updatedChats = prevChats.filter((_, i) => i !== existingChatIndex);
                return [existingChat, ...updatedChats];
            } else {
                // Se não existe, adicionar ao topo da lista
                return [chatUser, ...prevChats];
            }
        });
        
        // Navegar para a página de chat
        navigate('/chat');
        toast.success(`Abrindo chat com ${user.username}`);
    };
    const { user, token } = useAuth();
    const { username } = useParams();
    const location = useLocation();
    const navigate = useNavigate();
    const { myproducts, addProducts } = useContext(HomeContext);

    const handleMouseMove = (e) => {
        setTooltipPosition({
        x: e.clientX + 10, // Offset by 10px to not overlap with cursor
        y: e.clientY + 10
        });
    };
  
    
    // Efeito para carregar o perfil do usuário
    useEffect(() => {
        // Scroll to top when component mounts
        window.scrollTo(0, 0);
        
        // Resetar estados ao mudar de perfil
        setLoading(true);
        setLoadingproducts(true);
        setHasProfile(false);
        setIsMyProfile(false);
        setIsPublic(false);
        setProducts([]);
        
        // Função para carregar o perfil
        const carregarPerfil = async () => {
            try {
                // Verificar se é o próprio perfil do usuário
                if (user && user.username === username) {
                    console.log('Carregando perfil próprio:', username);
                    setIsMyProfile(true);
                    setHasProfile(true);
                    setUserProfile(user);
                    
                    // Carregar produtos do usuário
                    try {
                        const response = await api.get(`/usuario/${username}/produtos`);
                        if (response.data && response.data.produtos) {
                            setProducts(response.data.produtos);
                        }
                    } catch (error) {
                        console.error('Erro ao carregar produtos:', error);
                    }
                } else {
                    // Carregar perfil de outro usuário
                    console.log('Carregando perfil de outro usuário:', username);
                    try {
                        // Usar o endpoint correto para perfil de usuário
                        // Importante: a URL correta é /usuario/perfil/user/{username}
                        const headers = token ? { Authorization: `Bearer ${token}` } : {};
                        
                        // Fazendo uma chamada direta para garantir que funcione
                        const response = await axios.get(`https://skyvendamz-1.onrender.com/usuario/perfil/user/${username}`, {
                            headers: headers
                        });
                        
                        console.log('Resposta do perfil:', response.data);
                        
                        setIsMyProfile(false);
                        setHasProfile(true);
                        setUserProfile(response.data);
                        setIsPublic(true);
                        
                        // Os produtos já vêm na resposta da API
                        if (response.data.produtos) {
                            setProducts(response.data.produtos);
                        }
                    } catch (error) {
                        console.error('Erro ao carregar perfil de usuário:', error);
                        setHasProfile(false);
                        toast.error('Perfil não encontrado');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                setHasProfile(false);
                toast.error('Erro ao carregar perfil');
            } finally {
                setLoading(false);
                setLoadingproducts(false);
            }
        };
        
        if (username) {
            carregarPerfil();
        }
        
        // Definir a imagem de perfil para pré-visualização
        if (user?.perfil) {
            setPreviewImage(user.perfil);
        }
    }, [username, user]);

    useEffect(()=>{
        setTabSelected(location.pathname)

    },[location])
    
    useEffect(() => {
        if (!token && myproducts) return;
        if(myproducts?.length>=1){
          setLoadingproducts(false)
        }else{
          api.get(`/produtos/produtos/?skip=0&limit=20`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
          .then((res) => {
            addProducts(Array.isArray(res.data.produtos) ? res.data.produtos : []);
            console.log(res.data)
          })
          .catch((err) => {
            console.error('Erro ao buscar produtos:', err);
            addProducts([]);
          })
          .finally(() => setLoadingproducts(false));
        }
    
        
    }, [token]);


    const AvatarMenu=()=>{
        return (
        <div className="flex justify-center items-center w-full h-[100vh] z-[99999999999] bg-black/40 fixed top-0 left-0 p-4">
            <div className="w-full max-w-[450px] bg-white rounded-xl flex flex-col">
                <div className="flex flex-col items-center gap-1 border-b py-4 flex-1">
                    <img 
                        src={previewImage} 
                        className='w-[60px] h-[60px] rounded-full border'
                        />
                    <span>{userProfile.name}</span>
                    <span className='text-gray-400 text-xs'>usuario da skyvenda mz</span>
                </div>
                <div className="flex items-center justify-center p-4 font-bold text-indigo-400 border-b cursor-pointer">
                    <label className="cursor-pointer">
                        Carregar foto
                        <input type="file" accept="image/*" className="hidden" 
                        onChange={(e) => {
                            const file = e.target.files[0]; // Pegando o arquivo diretamente
                            setFileImage(file);
                            setPreviewImage(URL.createObjectURL(file));
                            setOpenAvatarMenu(false);
                            setUploading(true);
                        
                            const formData = new FormData();
                            const token = localStorage.getItem('auth_token');
                            formData.append('file', file); // Usando o arquivo diretamente
                        
                            api.put('/info_usuario/perfil', formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data',
                                    'Authorization': `Bearer ${token}`,
                                    'accept': 'application/json',
                                },
                            })
                            .then(res => {
                                setMessage('Imagem atualizada com sucesso!');
                                setFileImage(null);
                            })
                            .catch(err => {
                                setMessage('Erro ao atualizar a imagem. Tente novamente.');
                                console.error(err);
                            })
                            .finally(() => {
                                setUploading(false);
                            });
                        }}
                        />
                    </label>
                </div>
                <div className="flex items-center justify-center p-4  text-gray-600 relative border-b">
                    Adicionar uma mensagem
                </div>
                <div className="flex items-center justify-center p-4 font-bold text-red-400 border-b">
                    Remover a foto atual
                </div>
                <div className="flex items-center justify-center p-4 text-gray-600 " onClick={()=>setOpenAvatarMenu(false)}>
                    Cancer
                </div>

            </div>
        </div>
    )}


  return (
    <div className='w-full min-h-screen p-4 md:p-10'>
        <div className="container mx-auto">
            {!hasProfile && !loading ? (
                <div className="flex items-center justify-center min-h-screen flex-col gap-2">
                    <div className="flex justify-center items-center p-5 bg-gray-200 rounded-full">
                        <Info className="text-gray-900" />
                    </div>
                    <h1 className="text-2xl font-semibold">Perfil não está disponível</h1>
                    <p>A ligação pode não estar a funcionar ou o perfil pode ter sido removido.</p>
                    <Link 
                        to="/" 
                        className="py-3 px-4 bg-indigo-400 rounded-md hover:bg-indigo-600 text-white font-semibold"
                    >
                        Ver mais na SkyVenda MZ
                    </Link>
                </div>
            ) : !loading && hasProfile ? (
                isMyProfile ? (
                    <div className="container min-h-screen px-2 sm:px-4 lg:px-[140px] pb-[100px]">
                        <div className="w-full">
                            <div className="flex flex-col md:flex-row gap-6 md:gap-4 flex-1">
                                    {/* area do avatar */}
                                    <div 
                                        className="flex flex-col w-full items-center justify-center relative py-4 md:py-0 md:w-[282px] md:h-[182px]"
                                    >
                                        <div className="absolute -z-10 w-[120px] h-[120px] md:w-[155px] md:h-[155px] rounded-full bg-gradient-to-tr from-purple-500 via-pink-500 to-yellow-400" />
                                        {uploading && (
                                            <div className="absolute z-10 w-[120px] h-[120px] md:w-[155px] md:h-[155px] rounded-full bg-black/20 flex items-center justify-center">
                                            <Loader className='animate-spin text-white'/>
                                             </div>
                                        )}
                                        
                                        <img 
                                            src={previewImage}
                                            className="rounded-full border w-[115px] h-[115px] md:w-[150px] md:h-[150px]"
                                            alt="Profile"
                                            onMouseMove={handleMouseMove}
                                            onMouseEnter={() => setShowTooltip(true)}
                                            onMouseLeave={() => setShowTooltip(false)}
                                            onClick={()=>setOpenAvatarMenu(true)}
                                        />

                                        {showTooltip && (
                                        <div
                                            className="fixed z-50 bg-black text-white px-3 py-1 rounded-md  pointer-events-none text-xs"
                                            style={{
                                            left: `${tooltipPosition.x}px`,
                                            top: `${tooltipPosition.y}px`,
                                            }}
                                        >
                                            Mudar a foto do perfil
                                        </div>
                                        )}
                                    </div>

                                    {/* area das opcoes e informacoes */}
                                    <div className="w-full space-y-2">
                                        <div className="flex flex-col sm:flex-row py-2 md:h-[40px] gap-2 sm:gap-4 items-start sm:items-center flex-1">
                                            <span className='text-xl sm:text-2xl font-semibold'>{userProfile.username}</span>
                                            <div className="flex gap-2 flex-wrap">
                                                <Link to={'/accounts/edit'} className='bg-gray-200 py-1 sm:py-2 px-3 sm:px-4 text-sm sm:text-base rounded-md hover:bg-gray-300'>Editar Perfil</Link>
                                                <Link className='bg-gray-200 py-1 sm:py-2 px-3 sm:px-4 text-sm sm:text-base rounded-md hover:bg-gray-300'>Ver Publicaoes</Link>
                                                <Link>
                                                    <Settings className='hover:animate-spin'/>
                                                </Link>
                                            </div>
                                        </div>

                                        <div className="flex flex-wrap py-2 md:h-[40px] gap-4 items-center flex-1">
                                            <span><span className='font-bold'>{userProfile.total_produtos}</span> publicacoes</span>
                                            <span><span className='font-bold'>{userProfile.total_seguidores}</span> segudores</span>
                                            <span><span className='font-bold'>{userProfile.total_seguindo || 0}</span> A seguir</span>
                                        </div>
                                        <div className="">
                                            <p className='font-bold text-2xl'>{userProfile.name}</p>
                                            <p>{userProfile.email}</p>
                                        </div>
                                    </div>

                                </div>
                                <div className="flex h-[1px] bg-gray-300 mt-10 "></div>
                                {/* tabs */}
                                <div className="flex-1 gap-4">
                                    <div className="flex flex-wrap gap-2 sm:gap-8 justify-center items-center overflow-x-auto">
                                    <Link to={`/${username}`} className={`uppercase transition-all duration-300 gap-1 sm:gap-2 py-2 sm:py-3 flex text-xs sm:text-sm text-gray-500 ${tabSelected==`/${username}` && "font-bold text-gray-900 border-t-2 border-t-gray-900"}`}><Grid className="w-4 h-4 sm:w-5 sm:h-5"/>Produtos</Link>
                                    <Link to={`/${username}/orders`} className={`uppercase transition-all duration-100 gap-1 sm:gap-2 py-2 sm:py-3 flex text-xs sm:text-sm text-gray-500 ${tabSelected==`/${username}/orders` && "font-bold text-gray-900 border-t-2 border-t-gray-900"}`}><ClipboardList className="w-4 h-4 sm:w-5 sm:h-5"/>Pedidos</Link>
                                    <Link to={`/${username}/friends`} className={`uppercase transition-all duration-100 gap-1 sm:gap-2 py-2 sm:py-3 flex text-xs sm:text-sm text-gray-500 ${tabSelected==`/${username}/friends` && "font-bold text-gray-900 border-t-2 border-t-gray-900"}`}><User2 className="w-4 h-4 sm:w-5 sm:h-5"/>Amigos</Link>
                                    <Link to={`/${username}/ads`} className={`uppercase transition-all duration-100 gap-1 sm:gap-2 py-2 sm:py-3 flex text-xs sm:text-sm text-gray-500 ${tabSelected==`/${username}/ads` && "font-bold text-gray-900 border-t-2 border-t-gray-900"}`}><Megaphone className="w-4 h-4 sm:w-5 sm:h-5"/>Anúncios</Link>
                                    </div>
                                    {/* tabs content body */}
                                    <div className="flex-1">
                                        {tabSelected==`/${username}` &&(
                                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                                {loadingProducts ?(
                                                <>
                                                    {[1, 2, 3, 4, 5, 6].map((i) => (
                                                        <div key={i} className="bg-white rounded-lg overflow-hidden shadow-sm animate-pulse">
                                                        <div className="aspect-square bg-gray-200"></div>
                                                        <div className="p-4 space-y-3">
                                                            <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                                                            <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                                                        </div>
                                                        </div>
                                                    ))}
                                                </>
                                            ):(
                                               <>
                                                {myproducts.length>=1 ?(
                                                    <>
                                                        {myproducts.map((product, i) => (
                                                    <div
                                                        key={i}
                                                        className="bg-white border flex items-center justify-center aspect-square rounded-md relative group overflow-hidden shadow-xm hover:shadow-lg transition-shadow"
                                                    >
                                                        <img
                                                        src={`${base_url}/produto/${product.thumb}`}
                                                        onError={(e) => (e.target.src = `${base_url}/default.png`)}
                                                        className="w-full h-full object-cover transform transition-transform duration-300 group-hover:scale-110"
                                                        />
                                                        <div className="absolute inset-0 flex items-center justify-center bg-black/40 z-40 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                        <div className="flex font-bold text-white gap-4 text-sm md:text-base">
                                                            <div className="flex items-center gap-1">
                                                            <Heart /> {product?.likes || 0}
                                                            </div>
                                                            <div className="flex items-center gap-1">
                                                            <Eye /> {product?.views || 0}
                                                            </div>
                                                            <div className="flex items-center gap-1">
                                                            <MessageCircle /> {product?.comments?.length || 0}
                                                            </div>
                                                        </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                    </>
                                                ):(
                                                    <div className="g">
                                                        ainda nao tem produtos
                                                    </div>
                                                )}

                                               </> 
                                            )}
                                            </div> 
                                        )}
                                        {tabSelected==`/${username}/orders`&&(
                                            <Pedidos/>
                                        )}
                                    </div>
                                </div>

                            </div>

                        </div> 

                        ):(
                            <>
                            {/* perfil publico */}
                           <div className="container min-h-screen px-2 sm:px-4 lg:px-[140px] pb-[100px]">
                                <div className="w-full">
                                    <div className="flex flex-col md:flex-row gap-6 md:gap-4 flex-1">
                                        {/* area do avatar */}
                                         <div className="flex flex-col w-full items-center justify-center relative py-4 md:py-0 md:w-[282px] md:h-[182px]">
                                             <div className="absolute -z-10 w-[120px] h-[120px] md:w-[155px] md:h-[155px] rounded-full bg-gradient-to-tr from-purple-500 via-pink-500 to-yellow-400" />

                                             <div className="relative">
                                                  <img 
                                                      src={`${userProfile?.perfil}`}
                                                      className='rounded-full border w-[115px] h-[115px] md:w-[150px] md:h-[150px]'
                                                      alt="Foto de perfil"
                                                  />
                                             </div>

                                        {/* area das opcoes e informacoes */}
                                        <div className="w-full space-y-2">

                                            <div className="flex flex-col sm:flex-row py-1 md:h-[40px] gap-2 sm:gap-4 items-start sm:items-center flex-1">
                                                <div className="flex items-center gap-2">
                                                    <span className='text-xl sm:text-2xl font-semibold'>{userProfile.username}</span>
                                                    {userProfile.revisado === "sim" && (
                                                        <span className="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs font-medium bg-blue-50 text-blue-700">
                                                            <Award className="w-3 h-3 mr-0.5" />
                                                            Verificado
                                                        </span>
                                                    )}
                                                    <span className="inline-flex items-center px-1.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-700">
                                                        {userProfile.tipo}
                                                    </span>
                                                </div>
                                                <div className="flex gap-2 flex-wrap">
                                                    <button 
                                                        className={`inline-flex items-center px-3 py-1.5 rounded text-sm font-medium transition-colors ${followLoading ? 'opacity-75 cursor-not-allowed' : ''} ${userProfile.seguindo ? 'bg-gray-200 text-gray-900 hover:bg-gray-300' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
                                                        disabled={followLoading}
                                                        onClick={() => {
                                                            if (!token) {
                                                                toast.error('Você precisa estar logado para seguir este usuário');
                                                                return;
                                                            }
                                                            
                                                            // Ativar o estado de carregamento
                                                            setFollowLoading(true);
                                                            
                                                            // Implementar chamada para seguir/deixar de seguir
                                                            const novoStatus = !userProfile.seguindo;
                                                            
                                                            // Usar o ID do usuário em vez do nome de usuário
                                                            const userId = userProfile.id;
                                                            
                                                            // O endpoint "seguir" funciona como um toggle - basta chamar sempre o mesmo endpoint
                                                            // Se já está seguindo, ele vai deixar de seguir
                                                            // Se não está seguindo, ele vai seguir
                                                            
                                                            console.log(`Chamando endpoint de toggle seguir: /usuario/${userId}/seguir`);
                                                            
                                                            // Fazer a chamada direta com axios para garantir que funcione
                                                            axios({
                                                                method: 'POST',
                                                                url: `https://skyvendamz-1.onrender.com/usuario/${userId}/seguir`,
                                                                headers: {
                                                                    'accept': 'application/json',
                                                                    'Authorization': `Bearer ${token}`
                                                                },
                                                                data: ''
                                                            })
                                                            .then(response => {
                                                                console.log('Resposta seguir/deixar de seguir:', response.data);
                                                                
                                                                // Atualizar o estado local
                                                                setUserProfile(prev => ({
                                                                    ...prev,
                                                                    seguindo: novoStatus,
                                                                    total_seguidores: novoStatus ? prev.total_seguidores + 1 : prev.total_seguidores - 1
                                                                }));
                                                                
                                                                toast.success(novoStatus ? 
                                                                    `Agora você está seguindo ${userProfile.username}` : 
                                                                    `Você deixou de seguir ${userProfile.username}`);
                                                            })
                                                            .catch(error => {
                                                                console.error('Erro ao seguir/deixar de seguir:', error);
                                                                toast.error('Não foi possível realizar esta operação');
                                                            })
                                                            .finally(() => {
                                                                // Desativar o estado de carregamento após a conclusão
                                                                setFollowLoading(false);
                                                            });
                                                        }}
                                                    >
                                                        {followLoading ? (
                                                            <>
                                                                <Loader className="w-4 h-4 mr-1 animate-spin" />
                                                                {userProfile.seguindo ? 'Processando...' : 'Processando...'}
                                                            </>
                                                        ) : userProfile.seguindo ? (
                                                            <>
                                                                <UserCheck className="w-4 h-4 mr-1" />
                                                                Seguindo
                                                            </>
                                                        ) : (
                                                            <>
                                                                <UserPlus className="w-4 h-4 mr-1" />
                                                                Seguir
                                                            </>
                                                        )}
                                                    </button>
                                                    <button 
                                                        className='bg-gray-200 py-1 sm:py-2 px-3 sm:px-4 text-sm sm:text-base rounded-md hover:bg-gray-300 flex items-center gap-1'
                                                        onClick={() => handleOpenChat(userProfile)}
                                                    >
                                                        <MessageCircle className="w-4 h-4" />
                                                        Mensagem
                                                    </button>
                                                    <button>
                                                        <MoreHorizontal/>
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="flex flex-wrap py-2 md:h-[40px] gap-4 items-center flex-1">
                                                <span><span className='font-bold'>{userProfile.total_produtos || 0}</span> publicações</span>
                                                <span><span className='font-bold'>{userProfile.total_seguidores || 0}</span> seguidores</span>
                                                <span><span className='font-bold'>{userProfile.total_seguindo || 0}</span> a seguir</span>
                                            </div>
                                            <div className="flex justify-center items-center gap-2">
                                                <div className="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full">
                                                    <Package className="w-4 h-4 text-gray-500" />
                                                    <span className="text-xs text-gray-500">{userProfile.produtos_count || 0} produtos</span>
                                                </div>
                                                <div className="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full">
                                                    <Star className="w-4 h-4 text-gray-500" />
                                                    <span className="text-xs text-gray-500">{userProfile.avaliacao_media || 0} ({userProfile.avaliacoes_count || 0})</span>
                                                </div>
                                            </div>
                                            <div>
                                                <p className='font-bold text-2xl'>{userProfile.name}</p>
                                                <p>{userProfile.email}</p>
                                                {userProfile.biografia && <p className="mt-2">{userProfile.biografia}</p>}
                                                {userProfile.identificador_unico && (
                                                    <p className="text-sm text-gray-500 mt-1">ID: {userProfile.identificador_unico}</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex h-[1px] bg-gray-300 mt-10 "></div>
                                    {/* tabs */}
                                    <div className="flex-1 gap-4">
                                        <div className="flex gap-8 justify-center items-center">
                                        <Link to={`/${username}`} className={`uppercase transition-all duration-300 gap-2 py-3 flex text-gray-500 ${tabSelected==`/${username}` && "font-bold text-gray-900 border-t-2  border-t-gray-900 "}`}><Grid/>Produtos</Link>
                                        <Link to={`/${username}/friends`} className={`uppercase transition-all duration-100 gap-2 py-3 flex text-gray-500 ${tabSelected==`/${username}/friends` && "font-bold text-gray-900 border-t-2  border-t-gray-900"}`}><User2/>Seguidores</Link>
                                        <Link to={`/${username}/following`} className={`uppercase transition-all duration-100 gap-2 py-3 flex text-gray-500 ${tabSelected==`/${username}/following` && "font-bold text-gray-900 border-t-2  border-t-gray-900"}`}><UserPlus/>Seguindo</Link>
                                        <Link to={`/${username}/ads`} className={`uppercase transition-all duration-100 gap-2 py-3 flex text-gray-500 ${tabSelected==`/${username}/ads` && "font-bold text-gray-900 border-t-2  border-t-gray-900"}`}><Megaphone/>Anúncios</Link>
                                    </div>
                                        {/* tabs content body */}
                                        <div className="flex-1">
                                            {tabSelected==`/${username}` &&(
                                                <div className="grid grid-cols-3 gap-4">
                                                    {loadingProducts ?(
                                                    <>
                                                        {[1, 2, 3, 4, 5, 6].map((i) => (
                                                            <div key={i} className="bg-white rounded-lg overflow-hidden shadow-sm animate-pulse">
                                                            <div className="aspect-square bg-gray-200"></div>
                                                            <div className="p-4 space-y-3">
                                                                <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                                                                <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                                                            </div>
                                                            </div>
                                                        ))}
                                                    </>
                                                ):(
                                                   <>
                                                    {products.length>=1 ?(
                                                        <>
                                                        {products.map((product, i) => (
                                                            <div
                                                                key={i}
                                                                className="bg-white border flex flex-col items-center justify-center aspect-square rounded-md relative group overflow-hidden shadow-sm hover:shadow-lg transition-shadow"
                                                            >
                                                                <Link to={`/post/${product.slug}`} className="w-full h-full">
                                                                    <img
                                                                        src={product.capa || `${base_url}/default.png`}
                                                                        onError={(e) => (e.target.src = `${base_url}/default.png`)}
                                                                        className="w-full h-full object-cover transform transition-transform duration-300 group-hover:scale-110"
                                                                        alt={product.nome}
                                                                    />
                                                                    <div className="absolute inset-0 flex items-center justify-center bg-black/40 z-40 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                                        <div className="flex font-bold text-white gap-4 text-sm md:text-base">
                                                                            <div className="flex items-center gap-1">
                                                                                <Heart /> {product?.liked ? 'Gostado' : ''}
                                                                            </div>
                                                                            <div className="flex items-center gap-1">
                                                                                <Eye /> Ver
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </Link>
                                                                <div className="absolute bottom-0 left-0 right-0 bg-black/60 text-white p-2 text-sm">
                                                                    <p className="font-medium truncate">{product.nome}</p>
                                                                    <p className="text-green-300 font-bold">{product.preco} MZN</p>
                                                                </div>
                                                            </div>
                                                        ))}

                                                            </>
                                                        ):(
                                                            <div className="g">

                                                                ainda nao tem produtos

                                                            </div>
                                                        )}

                                                   </> 
                                                )}
                                                </div> 
                                            )}
                                            {tabSelected==`/${username}/friends`&&(
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
                                                    {userProfile.seguidores && userProfile.seguidores.length > 0 ? (
                                                        userProfile.seguidores.map((seguidor, index) => (
                                                            <div key={index} className="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                                                <div className="p-4">
                                                                    <div className="flex items-center space-x-3">
                                                                        <div className="flex-shrink-0">
                                                                            <img 
                                                                                className="h-10 w-10 rounded-full object-cover" 
                                                                                src={seguidor.perfil || 'https://storage.googleapis.com/skyvendamz1/default-avatar.png'} 
                                                                                onError={(e) => (e.target.src = 'https://storage.googleapis.com/skyvendamz1/default-avatar.png')}
                                                                                alt={seguidor.nome} 
                                                                            />
                                                                        </div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <p className="text-sm font-medium text-gray-900 truncate">{seguidor.nome}</p>
                                                                            <p className="text-sm text-gray-500 truncate">@{seguidor.username}</p>
                                                                        </div>
                                                                        <div>
                                                                            <Link to={`/${seguidor.username}`} className="inline-flex items-center px-2.5 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                                                Ver perfil
                                                                            </Link>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="col-span-full text-center py-10">
                                                            <p className="text-gray-500">Este usuário ainda não tem seguidores.</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            {tabSelected==`/${username}/following`&&(
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
                                                    {userProfile.a_seguir && userProfile.a_seguir.length > 0 ? (
                                                        userProfile.a_seguir.map((seguindo, index) => (
                                                            <div key={index} className="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                                                <div className="p-4">
                                                                    <div className="flex items-center space-x-3">
                                                                        <div className="flex-shrink-0">
                                                                            <img 
                                                                                className="h-10 w-10 rounded-full object-cover" 
                                                                                src={seguindo.perfil || 'https://storage.googleapis.com/skyvendamz1/default-avatar.png'} 
                                                                                onError={(e) => (e.target.src = 'https://storage.googleapis.com/skyvendamz1/default-avatar.png')}
                                                                                alt={seguindo.nome} 
                                                                            />
                                                                        </div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <p className="text-sm font-medium text-gray-900 truncate">{seguindo.nome}</p>
                                                                            <p className="text-sm text-gray-500 truncate">@{seguindo.username}</p>
                                                                        </div>
                                                                        <div>
                                                                            <Link to={`/${seguindo.username}`} className="inline-flex items-center px-2.5 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                                                Ver perfil
                                                                            </Link>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="col-span-full text-center py-10">
                                                            <p className="text-gray-500">Este usuário ainda não está seguindo ninguém.</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                ) : (
                    <div className="container min-h-screen px-2 sm:px-4 lg:px-[140px] pb-[100px]">
                        <div className="flex items-center justify-center min-h-screen">
                            <p className="text-lg text-gray-500">🔄 Carregando...</p>
                        </div>
                    </div>
                )
            ) : (
                <div className="flex items-center justify-center min-h-screen">
                    <p className="text-lg text-gray-500">🔄 Carregando...</p>
                </div>
            )}
        </div>
        {openAvatarMenu && <AvatarMenu/>}
    </div>
  );
}
